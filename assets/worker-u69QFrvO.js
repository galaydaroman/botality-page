(function(){"use strict";var freeGlobal=typeof global=="object"&&global&&global.Object===Object&&global,freeGlobal$1=freeGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal$1||freeSelf||Function("return this")(),root$1=root,Symbol=root$1.Symbol,Symbol$1=Symbol,objectProto$1=Object.prototype,hasOwnProperty=objectProto$1.hasOwnProperty,nativeObjectToString$1=objectProto$1.toString,symToStringTag$1=Symbol$1?Symbol$1.toStringTag:void 0;function getRawTag(e){var t=hasOwnProperty.call(e,symToStringTag$1),r=e[symToStringTag$1];try{e[symToStringTag$1]=void 0;var n=!0}catch{}var o=nativeObjectToString$1.call(e);return n&&(t?e[symToStringTag$1]=r:delete e[symToStringTag$1]),o}var objectProto=Object.prototype,nativeObjectToString=objectProto.toString;function objectToString(e){return nativeObjectToString.call(e)}var nullTag="[object Null]",undefinedTag="[object Undefined]",symToStringTag=Symbol$1?Symbol$1.toStringTag:void 0;function baseGetTag(e){return e==null?e===void 0?undefinedTag:nullTag:symToStringTag&&symToStringTag in Object(e)?getRawTag(e):objectToString(e)}function isObjectLike(e){return e!=null&&typeof e=="object"}var isArray=Array.isArray,isArray$1=isArray;function isObject(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var asyncTag="[object AsyncFunction]",funcTag="[object Function]",genTag="[object GeneratorFunction]",proxyTag="[object Proxy]";function isFunction(e){if(!isObject(e))return!1;var t=baseGetTag(e);return t==funcTag||t==genTag||t==asyncTag||t==proxyTag}var stringTag="[object String]";function isString(e){return typeof e=="string"||!isArray$1(e)&&isObjectLike(e)&&baseGetTag(e)==stringTag}function clearAngle(e){const t=e%360;return t<0?t+360:t}function direction(e,t,r,n){return e===r?t<n?270:90:t===n?e<r?0:180:clearAngle(-Math.atan2(n-t,r-e)*180/Math.PI)}function normalize180(e){let t=e%360;return Math.abs(t)>180&&(t+=t<0?360:-360),t}function angleRotation(e,t){return normalize180(t-e)}function angleSize(e,t){return Math.abs(angleRotation(t,e))}function getEnemyById(e,t){for(var r=0;r<t.length;r++)if(t[r].id==e)return t[r];return!1}function getShotDestination(e){return{x:e.x+Math.cos(e.angle/180*Math.PI)*e.range,y:e.y-Math.sin(e.angle/180*Math.PI)*e.range}}function getAngleControl(e,t){const r=angleRotation(e,t);return Math.abs(r)===180?Math.random()<.5?1:-1:Math.max(-1,Math.min(1,r))}const __SCRIPT_ACTION_FALLBACK=`
; if (!this.action) { try { this.action = action; } catch(e) {} }
`,__props=new WeakMap;class ScriptRunner{constructor(e,t){this.args=this.cache={},__props.set(this,{botId:e,registered:!1,logGroup:`[ScriptRunner @${t.name}] Bot <${e}>: `})}get registered(){return __props.get(this).registered}get logGroupName(){return __props.get(this).logGroup}registerScript(_script_321){if(this.registered)throw new Error("Script already registered");this.evalContext={args:this.args,cache:this.cache,log:this.log.bind(this)},(function({__props,args,cache,log,angleRotation,angleSize,clearAngle,getAngleControl,getDirection,getEnemyById,getShotDestination,angle_size,clear_angle,get_angle_control,get_direction,get_enemy_by_id,get_shot_destination}){try{eval(_script_321+__SCRIPT_ACTION_FALLBACK)}catch(e){throw e}}).bind(this.evalContext)({__props:null,args:this.args,cache:this.cache,log:this.evalContext.log,angleRotation,angleSize,clearAngle,getAngleControl,getDirection:direction,getEnemyById,getShotDestination,angle_size:angleSize,clear_angle:clearAngle,get_angle_control:getAngleControl,get_direction:direction,get_enemy_by_id:getEnemyById,get_shot_destination:getShotDestination});const action=this.evalContext.action;if(!isFunction(action))throw new Error(`${this.logGroupName}Script registrar didn't detect 'action' function`);return this.action=action.bind(this.evalContext),delete this.evalContext.action,__props.get(this).registered=!0,!0}run(){if(!this.registered)throw new Error("Register script");const e=arguments[0]||[];return this.action(...e)}log(){console.log&&console.log(this.logGroupName,...arguments)}}class Service{constructor(t){this.id=t.name||"undefined",this.context=t,this.runners={},console.log(`[WorkerService #${this.id}] Registered`)}getHandler(){return this.handler.bind(this)}postMessage(t,r,n){return this.context.postMessage({id:t,payload:r,error:n})}async handler(t){const r=t.data,{id:n,payload:o}=r||{},[i,...s]=o||[];switch(i){case"register":{this.register(n,...s);break}case"execute":{await this.execute(n,...s);break}case"ping":{this.postMessage(n,["pong"]);break}default:throw this.postMessage(n,[i,null],"Not supported worker action"),new Error(`[WorkerService #${this.id}] ${i} is not supported worker action`)}}register(t,r,n){if(!isString(r))throw this.postMessage(t,["register",r,{success:!1}],"Invalid bot identifier"),new Error(`[WorkerService #${this.id}] Bot "${r}" is not valid identifier. Please use strings.`);if(this.runners[r])throw this.postMessage(t,["register",r,{success:!1}],"Already registered"),new Error(`[WorkerService #${this.id}] Bot "${r}" already registered`);{const o=new ScriptRunner(r,this.context);try{o.registerScript(n)}catch(i){throw this.postMessage(t,["register",r,{success:!1}],`Script evaluation error: ${i}`),new Error(`[WorkerService #${this.id}] Script evaluation error for "${r}": ${i}
Stack: ${i.stack}`)}this.runners[r]=o,this.postMessage(t,["register",r,{success:!0}])}}async execute(t,r,n){const o=this.runners[r];let i=null;if(!o)throw this.postMessage(t,["execute",r,{success:!1}],"Bot not found"),new Error(`[WorkerService #${this.id}] Bot "${r}" is not registered`);try{i=await o.run(n)}catch(s){throw this.postMessage(t,["execute",r,{success:!1,stack:s.stack}],`Execution error: ${s}`),new Error(`[WorkerService #${this.id}] Execution error for "${r}": ${s}
Stack: ${s.stack}`)}this.postMessage(t,["execute",r,{success:!0,result:i}])}}const context=self,worker=new Service(context);context.onmessage=worker.getHandler(),self.importScripts=()=>{}})();
